<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>New Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>New Order</h4>
    <a class="btn btn-secondary" href="/">Home</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-md-6">
          <input id="customer_name" class="form-control" placeholder="Customer name">
        </div>
        <div class="col-md-6 text-end">
          <button class="btn btn-success" onclick="addRow()">Add Line</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <table class="table" id="order_tbl">
        <thead>
          <tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="d-flex justify-content-end align-items-center gap-3">
        <div class="input-group" style="width:220px;">
          <span class="input-group-text">Grand Total</span>
          <input id="grand_total" class="form-control" readonly>
        </div>
        <button class="btn btn-primary" onclick="submitOrder()">Submit Order</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/app.js"></script>
<script>
let productList = [];

async function ensureProducts(){
  if(productList.length) return;
  productList = await (await fetch('/api/products')).json();
}

async function addRow(){
  await ensureProducts();
  const tb = document.querySelector('#order_tbl tbody');
  const tr = document.createElement('tr');
  tr.className = 'order-item-row';
  const selId = `p_${Date.now()}`;
  tr.innerHTML = `
    <td>
      <select class="form-select oi-product" id="${selId}">
        ${productList.map(p => `<option value="${p.id}">${p.name} (${p.uom_name})</option>`).join('')}
      </select>
    </td>
    <td><input type="number" class="form-control oi-qty" min="0.01" step="0.01"></td>
    <td><input type="number" class="form-control oi-price" min="0.01" step="0.01"></td>
    <td><input class="form-control oi-total" readonly></td>
    <td><button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); recalcGrandTotal();">Remove</button></td>
  `;
  tb.appendChild(tr);
}

function requireNonEmptyInput(el, msg){
  if(!el.value || !el.value.toString().trim()){ el.classList.add('is-invalid'); alert(msg); throw new Error(msg); }
  el.classList.remove('is-invalid');
}
function requirePositiveNumber(el, msg){
  const v = Number(el.value);
  if(!(v>0)){ el.classList.add('is-invalid'); alert(msg); throw new Error(msg); }
  el.classList.remove('is-invalid');
}

function recalcLineTotal(row){
  const qty = Number(row.querySelector('.oi-qty').value || 0);
  const price = Number(row.querySelector('.oi-price').value || 0);
  row.querySelector('.oi-total').value = (qty * price).toFixed(2);
  recalcGrandTotal();
}
function recalcGrandTotal(){
  let sum = 0;
  document.querySelectorAll('.oi-total').forEach(t => sum += Number(t.value||0));
  document.getElementById('grand_total').value = sum.toFixed(2);
}

document.addEventListener('input', (e)=>{
  const row = e.target.closest('.order-item-row');
  if(!row) return;
  if(e.target.classList.contains('oi-qty') || e.target.classList.contains('oi-price')){
    recalcLineTotal(row);
  } else if(e.target.classList.contains('oi-total')){
    recalcGrandTotal();
  }
});

async function submitOrder(){
  const cname = document.getElementById('customer_name');
  requireNonEmptyInput(cname, 'Customer name is required');

  const rows = Array.from(document.querySelectorAll('.order-item-row'));
  if(rows.length === 0){ alert('Add at least one line'); return; }

  const items = [];
  for(const row of rows){
    const prodSel = row.querySelector('.oi-product');
    const qty = row.querySelector('.oi-qty');
    const price = row.querySelector('.oi-price');
    requireNonEmptyInput(prodSel, 'Item is required');
    requirePositiveNumber(qty, 'Quantity must be > 0');
    requirePositiveNumber(price, 'Price must be > 0');
    items.push({ product_id: Number(prodSel.value), qty: Number(qty.value), price: Number(price.value) });
  }
  const body = {
    customer_name: cname.value.trim(),
    items,
    total_amount: Number(document.getElementById('grand_total').value || 0)
  };
  const res = await fetch('/api/orders', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(res.ok){ alert('Order saved'); window.location.href='/orders.html'; }
  else { alert('Failed to save order'); }
}
</script>
</body>
</html>
