<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Products</h4>
    <a class="btn btn-secondary" href="/">Home</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title">Add New Product</h6>
      <div class="row g-2">
        <div class="col-md-4">
          <input id="p_name" class="form-control" placeholder="Product name">
        </div>
        <div class="col-md-3">
          <select id="p_uom" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <input id="p_price" type="number" step="0.01" class="form-control" placeholder="Price">
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" onclick="addProduct()">Add</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card my-3">
    <div class="card-body">
      <h6 class="card-title">Add New UOM</h6>
      <div class="d-flex gap-2">
        <input id="new_uom_name" class="form-control" placeholder="e.g., Cubic Meter">
        <button class="btn btn-success" onclick="addUom()">Add UOM</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <table class="table table-striped" id="products_tbl">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>UOM</th><th>Price</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal" id="editProductModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Edit Product</h5></div>
    <div class="modal-body">
      <form id="editProductForm">
        <input type="hidden" id="ep_id">
        <div class="mb-2">
          <label class="form-label">Name</label>
          <input id="ep_name" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">UOM</label>
          <select id="ep_uom" class="form-select"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Price</label>
          <input id="ep_price" type="number" step="0.01" class="form-control" required>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-primary" onclick="saveProductEdits()">Save</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/app.js"></script>
<script>
async function loadProducts(){
  await fillUoms('p_uom');
  const res = await fetch('/api/products');
  const rows = await res.json();
  const tb = document.querySelector('#products_tbl tbody');
  tb.innerHTML = '';
  for(const row of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.id}</td>
      <td>${row.name}</td>
      <td>${row.uom_name}</td>
      <td>${Number(row.price).toFixed(2)}</td>
      <td>
        <button class="btn btn-sm btn-primary me-2" onclick='openEditProduct(${JSON.stringify(row).replaceAll("'", "&apos;")})'>Edit</button>
        <button class="btn btn-sm btn-danger" onclick='deleteProduct(${row.id})'>Delete</button>
      </td>`;
    tb.appendChild(tr);
  }
}

async function addProduct(){
  const body = {
    name: document.getElementById('p_name').value.trim(),
    uom_id: Number(document.getElementById('p_uom').value),
    price: Number(document.getElementById('p_price').value || 0)
  };
  if(!body.name || !body.uom_id){ alert('Fill product name and UOM'); return; }
  const res = await fetch('/api/products', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(res.ok){ document.getElementById('p_name').value=''; document.getElementById('p_price').value=''; await loadProducts(); }
  else { alert('Add failed'); }
}

async function deleteProduct(id){
  if(!confirm('Delete this product?')) return;
  const res = await fetch('/api/products/'+id, {method:'DELETE'});
  if(res.ok){ await loadProducts(); } else { alert('Delete failed'); }
}

async function openEditProduct(row){
  document.getElementById('ep_id').value = row.id;
  document.getElementById('ep_name').value = row.name;
  document.getElementById('ep_price').value = row.price;
  await fillUoms('ep_uom', row.uom_id);
  bootstrap.Modal.getOrCreateInstance(document.getElementById('editProductModal')).show();
}

async function saveProductEdits(){
  const id = Number(document.getElementById('ep_id').value);
  const body = {
    name: document.getElementById('ep_name').value.trim(),
    uom_id: Number(document.getElementById('ep_uom').value),
    price: Number(document.getElementById('ep_price').value || 0)
  };
  if(!body.name || !body.uom_id){ alert('Fill all fields'); return; }
  const res = await fetch('/api/products/'+id, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(res.ok){ bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide(); await loadProducts(); } else { alert('Update failed'); }
}

async function addUom(){
  const name = document.getElementById('new_uom_name').value.trim();
  if(!name){ alert('UOM name required'); return; }
  const res = await fetch('/api/uoms', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
  if(res.ok){ document.getElementById('new_uom_name').value=''; await fillUoms('p_uom'); }
  else { alert('Failed to add UOM'); }
}

document.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>
